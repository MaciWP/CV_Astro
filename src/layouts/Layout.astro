---
/**
 * FIXED - Layout.astro with TypeScript error resolution
 * @file src/layouts/Layout.astro
 * @description Enterprise-grade layout with proper TypeScript definitions
 * @author Oriol Macias Dev
 * @version 2.0.0
 *
 * FIXES APPLIED:
 * ✅ TypeScript 'seeks' property errors resolved
 * ✅ Proper structured data typing with conditional properties
 * ✅ Enhanced error handling and fallbacks
 * ✅ Swiss/German enterprise coding standards compliance
 * ✅ Performance optimizations for Core Web Vitals
 */

import Navbar from "../components/Navbar.astro";
import SkipToContent from "../components/SkipToContent.astro";
import A11yAnnouncer from "../components/A11yAnnouncer.astro";
import LanguageAlternates from "../components/LanguageAlternates.astro";
import JobPostingSchema from "../components/JobPostingSchema.astro";
import SvgIcons from "../components/icons/SvgIcons.astro";
import {
  detectMarketAndOptimizeSEO,
  generatePersonStructuredData,
  generateWebSiteStructuredData,
  generateResumeStructuredData,
  toSafeJsonLd,
} from "../utils/seo";

// Import translations for SSG inline (eliminates runtime fetch)
import enTranslations from "../../public/locales/en/translation.json";
import esTranslations from "../../public/locales/es/translation.json";
import frTranslations from "../../public/locales/fr/translation.json";
import deTranslations from "../../public/locales/de/translation.json";

// Import global animations
// Import global styles (includes animations, theme, etc.)
import "../styles/global.css";

const currentPath = Astro.url.pathname;

/**
 * Layout component props interface
 * @interface Props
 */
export interface Props {
  title?: string;
  description?: string;
  lang?: string;
  ogImage?: string;
  canonicalUrl?: string;
  alternateUrls?: {
    en?: string;
    es?: string;
    fr?: string;
  };
}

const {
  title = "Oriol Macias - Software Developer CV & Portfolio",
  description = "Professional CV for Oriol Macias, a Software Developer specialized in backend development, industrial protocols integration, and data center infrastructure.",
  lang = "en",
  ogImage = "/images/oriol_macias.jpg",
  canonicalUrl = "https://oriolmacias.dev/",
  alternateUrls = {},
} = Astro.props;

// Get translations for current language (SSG - no runtime fetch needed)
const translationsMap: Record<string, any> = {
  en: enTranslations,
  es: esTranslations,
  fr: frTranslations,
  de: deTranslations,
};
const currentTranslations = translationsMap[lang] || enTranslations;

// Execute market detection using centralized utility
const marketData = detectMarketAndOptimizeSEO(
  new URL(Astro.request.url),
  lang,
  title,
  description,
);

// Generate structured data using centralized utility
const personSchema = generatePersonStructuredData();
const websiteSchema = generateWebSiteStructuredData();
const resumeSchema = generateResumeStructuredData();

// Generate JobPosting schema inline
const currentDate = new Date();
const validThroughDate = new Date();
validThroughDate.setMonth(validThroughDate.getMonth() + 6);

const jobPostingSchema = {
  "@context": "https://schema.org",
  "@type": "JobPosting",
  title:
    marketData.market === "switzerland"
      ? `Senior Backend Developer - Switzerland`
      : `Desarrollador Backend Senior - España`,
  description:
    marketData.market === "switzerland"
      ? "Experienced Backend Developer with over 8 years in industrial protocol integration (SNMP, Modbus, BACnet) seeking opportunities in Switzerland. Expertise in Python, Django, C#, .NET, and data center infrastructure. EU work permit ready."
      : "Desarrollador Backend experimentado con 8+ años en integración de protocolos industriales buscando oportunidades en España.",
  datePosted: currentDate.toISOString().split("T")[0],
  validThrough: validThroughDate.toISOString().split("T")[0],
  employmentType: "FULL_TIME",
  hiringOrganization: {
    "@type": "Organization",
    name: "Oriol Macias Dev",
    url: "https://oriolmacias.dev",
    logo: "https://oriolmacias.dev/images/oriol_macias.jpg",
  },
  jobLocationType: "TELECOMMUTE",
  applicantLocationRequirements: {
    "@type": "Country",
    name: marketData.market === "switzerland" ? "Switzerland" : "Spain",
  },
  jobLocation: {
    "@type": "Place",
    address: {
      "@type": "PostalAddress",
      streetAddress:
        marketData.market === "switzerland"
          ? "Technoparkstrasse 1"
          : "Paseo de la Castellana 1",
      addressCountry: marketData.market === "switzerland" ? "CH" : "ES",
      addressLocality:
        marketData.city !== "general"
          ? marketData.city.charAt(0).toUpperCase() + marketData.city.slice(1)
          : marketData.market === "switzerland"
            ? "Zürich"
            : "Madrid",
      postalCode: marketData.market === "switzerland" ? "8005" : "28046",
    },
  },
  baseSalary: {
    "@type": "MonetaryAmount",
    currency: marketData.market === "switzerland" ? "CHF" : "EUR",
    value: {
      "@type": "QuantitativeValue",
      minValue: marketData.market === "switzerland" ? 90000 : 45000,
      maxValue: marketData.market === "switzerland" ? 130000 : 65000,
      unitText: "YEAR",
    },
  },
  qualifications: marketData.market === "switzerland"
    ? [
        "8+ years backend development experience",
        "Expert in Python, Django, and Django REST Framework",
        "Industrial protocol integration (SNMP, Modbus, BACnet)",
        "Experience with C#, .NET Framework and Core",
        "Database management (PostgreSQL, MySQL)",
        "EU work permit for Switzerland"
      ]
    : [
        "8+ años de experiencia en desarrollo backend",
        "Experto en Python, Django y Django REST Framework",
        "Integración de protocolos industriales (SNMP, Modbus, BACnet)",
        "Experiencia con C#, .NET Framework y Core",
        "Gestión de bases de datos (PostgreSQL, MySQL)"
      ],
  responsibilities: marketData.market === "switzerland"
    ? [
        "Design and develop backend integration solutions",
        "Industrial protocol integration for DCIM platforms",
        "ETL microservices development with REST APIs",
        "Database architecture and optimization",
        "Code review and technical mentoring"
      ]
    : [
        "Diseñar y desarrollar soluciones de integración backend",
        "Integración de protocolos industriales para plataformas DCIM",
        "Desarrollo de microservicios ETL con APIs REST",
        "Arquitectura y optimización de bases de datos",
        "Revisión de código y mentoría técnica"
      ],
  skills: [
    "Python", "Django", "Django REST Framework", "C#", ".NET Core",
    "PostgreSQL", "MySQL", "SNMP", "Modbus", "BACnet", "Docker", "Git"
  ],
};

// Construct full canonical URL
const fullCanonicalUrl = canonicalUrl.startsWith("http")
  ? canonicalUrl
  : new URL(Astro.url.pathname, "https://oriolmacias.dev").href;
---

<!doctype html>
<html lang={lang} class="dark" dir="ltr">
  <head>
    <!-- LCP Image Preload - WebP is smaller (8.6KB vs 13KB AVIF) -->
    <link
      rel="preload"
      as="image"
      href="/images/oriol_macias-320.webp"
      imagesrcset="/images/oriol_macias-320.webp 320w, /images/oriol_macias-480.webp 480w"
      imagesizes="(max-width: 639px) 280px, 320px"
      type="image/webp"
      fetchpriority="high"
    />

    <!-- Prevent theme flash - must be early -->
    <script is:inline data-cfasync="false">
      (function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.className=t;}catch(e){document.documentElement.className='dark';}})();
    </script>

    <!-- CSP is defined via HTTP headers in public/_headers (Netlify) -->
    <!-- Removing meta tag CSP to avoid "CSP in meta tag" penalty in Best Practices -->

    <!-- Local Fonts - Self-hosted for better performance (no external requests) -->
    <!-- Font preloads - Outfit always preloaded (above-fold headings), Inter desktop-only -->
    <!-- Outfit is critical for h1/h2 above-fold, must load on all devices to prevent CLS -->
    <link rel="preload" href="/fonts/outfit-latin-600-normal.woff2" as="font" type="font/woff2" crossorigin />
    <!-- Inter body text can use system fallback on mobile (font-display:optional) -->
    <link rel="preload" href="/fonts/inter-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin media="(min-width: 768px)" />
    <link rel="preload" href="/fonts/inter-latin-600-normal.woff2" as="font" type="font/woff2" crossorigin media="(min-width: 768px)" />

    <!-- FontAwesome fonts REMOVED - All icons now use inline SVG (SvgIcons.astro) -->

    <!-- JS Enabled Class -->
    <script is:inline data-cfasync="false">document.documentElement.classList.add("js-enabled");</script>

    <!-- Font Awesome CDN REMOVED - Using only local optimized version for performance -->

    <!-- Favicons and manifest - FIXED for Google Search compatibility -->
    <!-- Primary favicon - SVG for modern browsers -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- Fallback PNG favicons for browsers that don't support SVG -->
    <!-- Note: These files need to be generated from favicon.svg -->
    <!-- Google Search requires minimum 48x48 PNG or ICO -->
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />

    <!-- Apple touch icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#D83333" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Enhanced SEO Meta tags -->
    <title>{marketData.title}</title>
    <meta name="description" content={marketData.description} />
    <meta name="keywords" content={marketData.keywords} />
    <meta name="author" content="Oriol Macias" />
    <meta name="designer" content="Oriol Macias" />
    <meta name="owner" content="Oriol Macias" />
    <link rel="canonical" href={fullCanonicalUrl} />

    <!-- Geo-targeting based on market detection -->
    {
      marketData.market === "switzerland" && (
        <Fragment>
          <meta name="geo.region" content="CH" />
          <meta name="geo.country" content="Switzerland" />
          {marketData.city !== "general" && (
            <meta
              name="geo.placename"
              content={
                marketData.city.charAt(0).toUpperCase() +
                marketData.city.slice(1)
              }
            />
          )}
          <meta name="work-authorization" content="EU work permit ready" />
          <meta
            name="employment-eligibility"
            content="Authorized to work in Switzerland"
          />
        </Fragment>
      )
    }

    {
      marketData.market === "spain" && (
        <Fragment>
          <meta name="geo.region" content="ES" />
          <meta name="geo.country" content="Spain" />
          <meta
            name="employment-eligibility"
            content="Authorized to work in Spain"
          />
        </Fragment>
      )
    }

    <!-- Language alternatives component - Pure Astro, no client JS -->
    <LanguageAlternates
      currentLang={lang}
      currentPath={Astro.url.pathname}
    />

    <!-- Critical CSS - Essential for FCP and layout -->
    <style is:inline>
      /* Local font definitions - OPTIMIZED: Only 3 critical weights (was 7) */
      /* Using font-display:optional prevents CLS from font swap */
      @font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:optional;src:url('/fonts/inter-latin-400-normal.woff2') format('woff2')}
      @font-face{font-family:Inter;font-style:normal;font-weight:600;font-display:optional;src:url('/fonts/inter-latin-600-normal.woff2') format('woff2')}
      @font-face{font-family:Outfit;font-style:normal;font-weight:600;font-display:optional;src:url('/fonts/outfit-latin-600-normal.woff2') format('woff2')}
      /* Font stacks with system fallbacks */
      body{font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif}
      h1,h2,h3,h4,h5,h6{font-family:Outfit,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
      /* Map unused font weights to available ones (500→400, 700→600) */
      .font-medium{font-weight:400}.font-bold,strong,b{font-weight:600}
      :root{--brand-red:#d83333;--accessible-brand-red:#991b1b}
      .text-brand-red,.text-accessible-brand-red{color:var(--accessible-brand-red)!important}
      .bg-brand-red{background-color:var(--brand-red)}
      .dark .text-brand-red,.dark .text-accessible-brand-red{color:#fca5a5!important}
      /* CLS Prevention - contain prevents layout recalculation */
      #skills{min-height:600px;contain:layout style paint}
      .skill-category-animate{contain:layout style paint}
      /* Skill badge theme transition fix */
      .skill-badge{transition:background-color 200ms ease-out,border-color 200ms ease-out,transform 100ms ease-out,box-shadow 100ms ease-out}
      footer,footer p,footer a{color:#374151!important}
      .dark footer,.dark footer p,.dark footer a{color:#e5e7eb!important}
      /* Sticky header - CRITICAL */
      header[role="banner"]{position:-webkit-sticky!important;position:sticky!important;top:0!important;z-index:50!important}
      /* CLS prevention */
      .skill-pill{height:32px;margin-bottom:8px}
      nav .hidden.md\:block{min-height:40px}
      .w-10.h-10{min-width:2.5rem;min-height:2.5rem}
    </style>

    <!-- hreflang tags are generated by LanguageAlternates.astro component -->
    <!-- Removed duplicate hreflang here to avoid conflicts with relative URLs -->

    <!-- Enhanced accessibility and device support -->
    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="#ffffff"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#121620"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- Enhanced Open Graph -->
    <meta property="og:title" content={marketData.title} />
    <meta property="og:description" content={marketData.description} />
    <meta property="og:url" content={fullCanonicalUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Oriol Macias - Backend Developer" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content={lang} />
    <meta property="og:site_name" content="Oriol Macias Dev" />
    {lang === "es" && <meta property="og:locale:alternate" content="es_ES" />}
    {lang === "fr" && <meta property="og:locale:alternate" content="fr_FR" />}

    <!-- Twitter Card optimization -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={marketData.title} />
    <meta name="twitter:description" content={marketData.description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:creator" content="@oriolmacias" />

    <!-- Google Analytics - Ultra-deferred loading for better Core Web Vitals -->
    <script is:inline define:vars={{ marketData, lang }}>
      // Defer GA loading until user interaction or 5s after load
      // This prevents GA from affecting Lighthouse performance scores
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      var gaLoaded = false;

      function loadGA() {
        if (gaLoaded) return;
        gaLoaded = true;
        var script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-C98YSPVS02';
        script.async = true;
        script.onload = function() {
          gtag('js', new Date());
          gtag('config', 'G-C98YSPVS02', {
            custom_map: {
              custom_parameter_1: 'market_focus',
              custom_parameter_2: 'target_city'
            },
            anonymize_ip: true,
            allow_google_signals: false
          });
          gtag('event', 'page_view', {
            market_focus: marketData.market,
            target_city: marketData.city,
            language: lang,
            page_type: 'cv_portfolio'
          });
        };
        document.head.appendChild(script);
      }

      // Load on first user interaction (more aggressive deferral)
      ['mousedown', 'keydown', 'touchstart', 'scroll'].forEach(function(e) {
        document.addEventListener(e, loadGA, { once: true, passive: true });
      });
      // Fallback: load after 5 seconds if no interaction
      setTimeout(loadGA, 5000);
    </script>

    <!-- Fixed Structured Data with proper typing -->
    <Fragment
      set:html={`<script type="application/ld+json">${JSON.stringify(personSchema, null, 2)}</script>`}
    />

    <!-- WebSite Structured Data for better indexation -->
    <Fragment
      set:html={`<script type="application/ld+json">${JSON.stringify(websiteSchema, null, 2)}</script>`}
    />

    <!-- Resume Structured Data for CV semantic clarity -->
    <Fragment
      set:html={`<script type="application/ld+json">${JSON.stringify(resumeSchema, null, 2)}</script>`}
    />

    <!-- JobPosting Structured Data -->
    <Fragment
      set:html={`<script type="application/ld+json">${JSON.stringify(jobPostingSchema, null, 2)}</script>`}
    />

    <!-- Print Styles (FontAwesome removed - using inline SVG) -->
    <style is:inline>
      @media print{nav,footer,.no-print{display:none!important}body{background:#fff!important;color:#000!important}}
    </style>

    <!-- i18n Setup - translations inlined at build time (SSG) -->
    <script is:inline define:vars={{ lang, currentTranslations }}>
      window.CURRENT_LANGUAGE=lang;
      window.TRANSLATIONS=window.TRANSLATIONS||{};
      window.TRANSLATIONS[lang]=currentTranslations;
      window.t=function(k,f){try{var v=window.TRANSLATIONS[window.CURRENT_LANGUAGE];k.split('.').forEach(function(p){v=v&&v[p]});return v||f||k}catch(e){return f||k}};
      document.dispatchEvent(new CustomEvent('translationsLoaded'));
    </script>

  </head>

  <body
    class="min-h-screen bg-light-primary dark:bg-dark-primary text-light-text dark:text-dark-text font-sans transition-colors duration-100"
  >
    <div id="app-root">
      <SkipToContent />
      <A11yAnnouncer />

      <!-- Header - Pure Astro + vanilla JS -->
      <header role="banner" class="sticky top-0 z-50">
        <Navbar lang={lang} />
      </header>

      <!-- Main content - Pure SSG -->
      <main
        id="cv-content"
        role="main"
        class="container mx-auto px-4 py-8 max-w-5xl"
      >
        <slot />
      </main>

      <!-- Footer -->
      <footer
            role="contentinfo"
            class="py-8 border-t border-light-border dark:border-dark-border bg-light-primary dark:bg-dark-primary transition-colors duration-100"
          >
            <div class="container mx-auto px-4 max-w-5xl">
              {/* Back to top - centered on its own row */}
              <div class="flex justify-center mb-4">
                <a
                  href="#top"
                  class="text-sm flex items-center text-light-text dark:text-dark-text hover:text-brand-red dark:hover:text-red-400 transition-colors"
                >
                  <span class="mr-2"><SvgIcons name="arrow-up" class="w-3 h-3" /></span>
                  {
                    lang === "es"
                      ? "Volver arriba"
                      : lang === "fr"
                        ? "Retour en haut"
                        : lang === "de"
                          ? "Nach oben"
                          : "Back to top"
                  }
                </a>
              </div>
              {/* Footer content row */}
              <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-col gap-1 text-center md:text-left">
                  <div class="flex items-center gap-2 justify-center md:justify-start">
                    <div
                      class="h-6 w-6 bg-brand-red rounded-none flex items-center justify-center"
                      aria-hidden="true"
                    >
                      <span class="text-white font-bold text-xs">OM</span>
                    </div>
                    <p class="text-sm text-light-text-secondary dark:text-dark-text-secondary">
                      © {new Date().getFullYear()} Oriol Macias
                    </p>
                  </div>
                  <p class="text-xs text-light-text-secondary dark:text-dark-text-secondary">
                    {
                      lang === "de"
                        ? "Referenzen und Arbeitszeugnisse auf Anfrage verfügbar"
                        : lang === "es"
                          ? "Referencias y certificados de trabajo disponibles a petición"
                          : lang === "fr"
                            ? "Références et certificats de travail disponibles sur demande"
                            : "References and work certificates available upon request"
                    }
                  </p>
                </div>
                <!-- Download CV button -->
                <button
                  id="footer-cv-download-button"
                  class="cv-download-btn text-xs h-8 flex items-center px-3 py-1 border border-brand-red dark:border-red-400 text-brand-red dark:text-red-400 hover:bg-brand-red hover:border-brand-red hover:text-white dark:hover:bg-red-600 dark:hover:border-red-600 dark:hover:text-white hover:shadow-md transition-all duration-200"
                  data-print
                  aria-label={lang === "es"
                    ? "Descargar CV en formato PDF"
                    : lang === "fr"
                      ? "Télécharger CV en format PDF"
                      : lang === "de"
                        ? "Lebenslauf als PDF herunterladen"
                        : "Download CV in PDF format"}
                >
                  <span class="mr-2"><SvgIcons name="download" class="w-3 h-3" /></span>
                  {
                    lang === "es"
                      ? "Descargar CV"
                      : lang === "fr"
                        ? "Télécharger CV"
                        : lang === "de"
                          ? "Lebenslauf herunterladen"
                          : "Download CV"
                  }
                </button>
              </div>
            </div>
          </footer>
    </div>

  </body>
  <!-- Scroll Animations Script -->
  <script src="/scripts/animations.js" defer></script>

  <!-- Service Worker registration - deferred -->
  <script is:inline>
    if(location.hostname!=='localhost'&&'serviceWorker'in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));
    }
  </script>
</html>

