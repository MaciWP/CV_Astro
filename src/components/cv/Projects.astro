---
/**
 * Projects component - Pure Astro with vanilla JS for tabs and expand/collapse
 * @file src/components/cv/Projects.astro
 */
import { getPersonalProjects, getProfessionalProjects, getTechIcon } from '../../data/projects';
import SvgIcons from '../icons/SvgIcons.astro';

interface Props {
    lang?: string;
}

const { lang = 'en' } = Astro.props;

// Get translated data at build time
const personalProjects = getPersonalProjects(lang);
const professionalProjects = getProfessionalProjects(lang);

// UI translations
const translationsByLang: Record<string, Record<string, string>> = {
    en: {
        title: 'Key Projects',
        technologies: 'Technologies',
        keyFeatures: 'Key Features',
        viewOnGithub: 'View on GitHub',
        showAllDetails: 'Show all details',
        showLessDetails: 'Show less details',
        personalProjects: 'Personal Projects',
        professionalWork: 'Professional Work',
        personalProjectsNote: "These are personal projects I've developed to explore technologies and solve specific challenges.",
        professionalProjectsNote: 'These are just some of the professional projects developed during my work at Bjumper. Repositories are private due to confidentiality agreements.'
    },
    es: {
        title: 'Proyectos Clave',
        technologies: 'Tecnologías',
        keyFeatures: 'Características Clave',
        viewOnGithub: 'Ver en GitHub',
        showAllDetails: 'Mostrar todos los detalles',
        showLessDetails: 'Mostrar menos detalles',
        personalProjects: 'Proyectos Personales',
        professionalWork: 'Trabajo Profesional',
        personalProjectsNote: 'Estos son proyectos personales que he desarrollado para explorar tecnologías y resolver desafíos específicos.',
        professionalProjectsNote: 'Estos son solo algunos de los proyectos profesionales desarrollados durante mi trabajo en Bjumper. Los repositorios son privados debido a acuerdos de confidencialidad.'
    },
    fr: {
        title: 'Projets Clés',
        technologies: 'Technologies',
        keyFeatures: 'Fonctionnalités Clés',
        viewOnGithub: 'Voir sur GitHub',
        showAllDetails: 'Afficher tous les détails',
        showLessDetails: 'Afficher moins de détails',
        personalProjects: 'Projets Personnels',
        professionalWork: 'Travail Professionnel',
        personalProjectsNote: "Ce sont des projets personnels que j'ai développés pour explorer des technologies et résoudre des défis spécifiques.",
        professionalProjectsNote: "Voici quelques-uns des projets professionnels développés pendant mon travail chez Bjumper. Les dépôts sont privés en raison d'accords de confidentialité."
    },
    de: {
        title: 'Schlüsselprojekte',
        technologies: 'Technologien',
        keyFeatures: 'Hauptmerkmale',
        viewOnGithub: 'Auf GitHub ansehen',
        showAllDetails: 'Alle Details anzeigen',
        showLessDetails: 'Weniger Details anzeigen',
        personalProjects: 'Persönliche Projekte',
        professionalWork: 'Berufliche Arbeit',
        personalProjectsNote: 'Dies sind persönliche Projekte, die ich entwickelt habe, um Technologien zu erkunden und spezifische Herausforderungen zu lösen.',
        professionalProjectsNote: 'Dies sind nur einige der professionellen Projekte, die während meiner Arbeit bei Bjumper entwickelt wurden. Repositories sind aufgrund von Vertraulichkeitsvereinbarungen privat.'
    }
};

const t = translationsByLang[lang] || translationsByLang.en;

// Helper to get FA icon class (for JS data attribute)
function getProjectIcon(project: any): string {
    if (project.id === "vmware-service" && !project.icon) {
        return "fas fa-cloud"; // VMware uses cloud icon
    }
    return project.icon || "fas fa-code";
}

// Helper to get icon name (normalized for SvgIcons component)
function getProjectIconName(project: any): string {
    const iconMap: Record<string, string> = {
        "fas fa-server": "server",
        "fas fa-exchange-alt": "exchange-alt",
        "fas fa-network-wired": "network-wired",
        "fas fa-cloud": "cloud",
        "fas fa-tags": "tags",
        "fas fa-bolt": "bolt",
        "fas fa-id-card": "id-card",
        "fas fa-eye": "eye",
        "fas fa-code": "code"
    };

    const faIcon = getProjectIcon(project);
    return iconMap[faIcon] || "code";
}
---

<section id="projects" class="pt-4 projects-section">
    <!-- Header with CSS animation (via .projects-section.visible) -->
    <div class="flex items-center mb-6 section-header">
        <div class="w-10 h-10 flex items-center justify-center bg-brand-red text-white rounded-none section-icon">
            <SvgIcons name="project-diagram" class="w-4 h-4" />
        </div>
        <h2 class="text-2xl font-bold ml-3">{t.title}</h2>

        <!-- Toggle all details button -->
        <button
            id="toggle-all-details"
            class="ml-auto text-brand-red hover:text-brand-red/80 text-sm inline-flex items-center gap-2 focus:outline-none min-h-[48px] px-3 py-2"
            data-show-all={t.showAllDetails}
            data-show-less={t.showLessDetails}
        >
            <span class="toggle-icon transition-transform duration-200">
                <SvgIcons name="chevron-down" class="w-3 h-3" />
            </span>
            <span class="btn-text">{t.showAllDetails}</span>
        </button>
    </div>

    <!-- Tabs - Professional first -->
    <div class="flex border-b border-light-border dark:border-dark-border mb-6">
        <button
            class="tab-btn min-h-[48px] py-3 px-5 font-medium text-base transition-colors duration-150 text-brand-red dark:text-red-400 border-b-2 border-brand-red dark:border-red-400"
            data-tab="professional"
        >
            {t.professionalWork}
        </button>
        <button
            class="tab-btn min-h-[48px] py-3 px-5 font-medium text-base transition-colors duration-150 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-red/70 dark:hover:text-red-400/70"
            data-tab="personal"
        >
            {t.personalProjects}
        </button>
    </div>

    <!-- Personal Projects Grid (hidden by default now) -->
    <div id="personal-projects" class="projects-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        {personalProjects.map((project, index) => (
            <div
                class="project-card group bg-light-surface dark:bg-dark-surface rounded-none overflow-hidden border border-light-border dark:border-dark-border shadow-sm hover:shadow-lg hover:border-brand-red/50 hover:-translate-y-1 h-full flex flex-col cursor-pointer"
                style={`--delay: ${120 * index}ms`}
                data-github-url={project.githubUrl}
                tabindex="0"
                role="link"
                aria-label={`${t.viewOnGithub}: ${project.title}`}
            >
                <!-- Header -->
                <div class={`bg-brand-red p-3 flex items-center justify-between gap-3 text-white ${project.highlight ? 'border-l-4 border-l-white/50' : ''}`}>
                    <div class="flex items-center gap-2">
                        <span class="flex-shrink-0"><SvgIcons name={getProjectIconName(project)} class="w-5 h-5" /></span>
                        <h3 class="font-bold text-lg">{project.title}</h3>
                    </div>
                    {project.githubUrl && (
                        <a
                            href={project.githubUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="github-link hover:text-white/80 transition-colors z-30 relative"
                            aria-label={`GitHub: ${project.title}`}
                        >
                            <SvgIcons name="github" class="w-5 h-5" />
                        </a>
                    )}
                </div>

                <div class="p-5 flex-grow flex flex-col">
                    <p class="description mb-4 text-light-text-secondary dark:text-dark-text-secondary">
                        {project.description}
                    </p>
                    <p class="long-description mb-4 text-light-text-secondary dark:text-dark-text-secondary hidden">
                        {project.longDescription}
                    </p>

                    <!-- Key Features - hidden by default -->
                    <div class="key-features mb-4 hidden">
                        <h4 class="text-sm uppercase text-brand-red dark:text-brand-red font-semibold mb-2 tracking-wider">
                            {t.keyFeatures}
                        </h4>
                        <ul class="space-y-2 text-sm">
                            {project.keyFeatures.map((feature: string) => (
                                <li class="flex items-start gap-2">
                                    <span class="text-brand-red flex-shrink-0 mt-1"><SvgIcons name="check" class="w-3 h-3" /></span>
                                    <span>{feature}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <!-- Technologies -->
                    <div class="mt-auto">
                        <h4 class="text-xs uppercase text-light-text-secondary dark:text-dark-text-secondary font-semibold mb-2">
                            {t.technologies}
                        </h4>
                        <div class="flex flex-wrap gap-2 mt-2">
                            {project.technologies.map((tech: string) => (
                                <span class="tech-tag px-2 py-1 text-xs border border-light-border dark:border-dark-border rounded-none bg-light-secondary dark:bg-dark-secondary hover:border-brand-red transition-colors duration-150 flex items-center gap-1.5">
                                    <i class={`${getTechIcon(tech)} text-brand-red`}></i>
                                    {tech}
                                </span>
                            ))}
                        </div>
                    </div>

                </div>
            </div>
        ))}
    </div>

    <!-- Professional Projects Grid - Visible by default, load immediately -->
    <div id="professional-projects" class="projects-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
         data-projects={JSON.stringify(professionalProjects.map(p => ({
            id: p.id,
            title: p.title,
            description: p.description,
            longDescription: p.longDescription,
            technologies: p.technologies,
            keyFeatures: p.keyFeatures,
            icon: getProjectIcon(p),
            company: p.company,
            highlight: p.highlight
         })))}
         data-translations={JSON.stringify({
            technologies: t.technologies,
            keyFeatures: t.keyFeatures
         })}>
        <!-- Content loaded on first tab click -->
    </div>

    <!-- Footer note -->
    <div class="mt-8 text-center footer-note">
        <p id="professional-note" class="text-sm text-light-text-secondary dark:text-dark-text-secondary">
            {t.professionalProjectsNote}
        </p>
        <p id="personal-note" class="text-sm text-light-text-secondary dark:text-dark-text-secondary hidden">
            {t.personalProjectsNote}
        </p>
    </div>
</section>

<style>
    /* Initial state - hidden */
    .section-header,
    .footer-note {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 400ms ease-out, transform 400ms ease-out;
    }

    /* Project cards use CSS animation for both static and dynamically loaded cards */
    .project-card {
        animation: projectCardFadeIn 400ms ease-out forwards;
        animation-delay: var(--delay, 0ms);
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes projectCardFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Theme transitions */
    .project-card {
        transition: box-shadow 150ms ease-out,
                    background-color var(--theme-transition-duration, 100ms) ease-out,
                    border-color var(--theme-transition-duration, 100ms) ease-out,
                    color var(--theme-transition-duration, 100ms) ease-out;
    }

    /* Visible state for header and footer */
    .projects-section.visible .section-header,
    .projects-section.visible .footer-note {
        opacity: 1;
        transform: translateY(0);
    }

    /* Tab transitions */
    .projects-grid {
        transition: opacity 150ms ease-out;
    }

    .projects-grid.transitioning {
        opacity: 0;
    }

    /* Tab button states */
    .tab-btn.active {
        color: var(--brand-red, #d83333);
        border-bottom: 2px solid var(--brand-red, #d83333);
    }

    .dark .tab-btn.active {
        color: #f87171;
        border-color: #f87171;
    }

    .tab-btn:not(.active) {
        border-bottom: 2px solid transparent;
    }

    /* Toggle icon rotation */
    #toggle-all-details .toggle-icon {
        display: inline-block;
        transition: transform 200ms ease-out;
    }

    #toggle-all-details.expanded .toggle-icon {
        transform: rotate(180deg);
    }
</style>

<script is:inline>
    // SVG icon map for project headers (inline SVG for better alignment)
    const projectIconSvg = {
        server: '<svg class="w-5 h-5" viewBox="0 0 512 512" fill="currentColor"><path d="M480 160H32c-17.673 0-32-14.327-32-32V64c0-17.673 14.327-32 32-32h448c17.673 0 32 14.327 32 32v64c0 17.673-14.327 32-32 32zm-48-88c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24zm-64 0c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24zm112 248H32c-17.673 0-32-14.327-32-32v-64c0-17.673 14.327-32 32-32h448c17.673 0 32 14.327 32 32v64c0 17.673-14.327 32-32 32zm-48-88c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24zm-64 0c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24zm112 248H32c-17.673 0-32-14.327-32-32v-64c0-17.673 14.327-32 32-32h448c17.673 0 32 14.327 32 32v64c0 17.673-14.327 32-32 32zm-48-88c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24zm-64 0c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24z"/></svg>',
        'exchange-alt': '<svg class="w-5 h-5" viewBox="0 0 512 512" fill="currentColor"><path d="M0 168v-16c0-13.255 10.745-24 24-24h360V80c0-21.367 25.899-32.042 40.971-16.971l80 80c9.372 9.373 9.372 24.569 0 33.941l-80 80C409.956 271.982 384 261.456 384 240v-48H24c-13.255 0-24-10.745-24-24zm488 152H128v-48c0-21.314-25.862-32.08-40.971-16.971l-80 80c-9.372 9.373-9.372 24.569 0 33.941l80 80C102.057 463.997 128 453.437 128 432v-48h360c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24z"/></svg>',
        'network-wired': '<svg class="w-5 h-5" viewBox="0 0 640 512" fill="currentColor"><path d="M640 264v-16c0-8.84-7.16-16-16-16H344v-40h72c17.67 0 32-14.33 32-32V32c0-17.67-14.33-32-32-32H224c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h72v40H16c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h104v40H64c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h160c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32h-56v-40h304v40h-56c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h160c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32h-56v-40h104c8.84 0 16-7.16 16-16zM256 128V64h128v64H256zm-64 320H96v-64h96v64zm352 0h-96v-64h96v64z"/></svg>',
        cloud: '<svg class="w-5 h-5" viewBox="0 0 640 512" fill="currentColor"><path d="M537.6 226.6c4.1-10.7 6.4-22.4 6.4-34.6 0-53-43-96-96-96-19.7 0-38.1 6-53.3 16.2C367 64.2 315.3 32 256 32c-88.4 0-160 71.6-160 160 0 2.7.1 5.4.2 8.1C40.2 219.8 0 273.2 0 336c0 79.5 64.5 144 144 144h368c70.7 0 128-57.3 128-128 0-61.9-44-113.6-102.4-125.4z"/></svg>',
        tags: '<svg class="w-5 h-5" viewBox="0 0 640 512" fill="currentColor"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg>',
        bolt: '<svg class="w-5 h-5" viewBox="0 0 320 512" fill="currentColor"><path d="M296 160H180.6l42.6-129.8C227.2 15 215.7 0 200 0H56C44 0 33.8 8.9 32.2 20.8l-32 240C-1.7 275.2 9.5 288 24 288h118.7L96.6 482.5c-3.6 15.2 8 29.5 23.3 29.5 8.4 0 16.4-4.4 20.8-12l176-304c9.3-15.9-2.2-36-20.7-36z"/></svg>',
        code: '<svg class="w-5 h-5" viewBox="0 0 640 512" fill="currentColor"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2l43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6l144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg>',
        check: '<svg class="w-3 h-3" viewBox="0 0 512 512" fill="currentColor"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg>'
    };

    // Map FA icon classes to SVG keys
    const faToSvgKey = {
        'fas fa-server': 'server',
        'fas fa-exchange-alt': 'exchange-alt',
        'fas fa-network-wired': 'network-wired',
        'fas fa-cloud': 'cloud',
        'fas fa-tags': 'tags',
        'fas fa-bolt': 'bolt',
        'fas fa-code': 'code'
    };

    function getProjectIconSvg(iconClass) {
        const key = faToSvgKey[iconClass] || 'code';
        return '<span class="flex-shrink-0">' + projectIconSvg[key] + '</span>';
    }

    // Tech icon mapping for lazy-loaded projects (still FA for tech tags - less critical)
    const techIconMap = {
        'Python': 'fab fa-python', 'JavaScript': 'fab fa-js', 'TypeScript': 'fab fa-js',
        'Java': 'fab fa-java', 'C#': 'fab fa-microsoft', 'HTML': 'fab fa-html5',
        'CSS': 'fab fa-css3-alt', 'React': 'fab fa-react', 'Docker': 'fab fa-docker',
        'AWS': 'fab fa-aws', 'Git': 'fab fa-git-alt', 'GitHub': 'fab fa-github',
        '.NET': 'fab fa-windows', 'Django': 'fas fa-cubes', 'FastAPI': 'fas fa-bolt',
        'Flask': 'fas fa-flask', 'PostgreSQL': 'fas fa-database', 'MySQL': 'fas fa-database',
        'Redis': 'fas fa-server', 'REST API': 'fas fa-exchange-alt', 'Celery': 'fas fa-tasks',
        'SQLAlchemy': 'fas fa-database', 'Alembic': 'fas fa-code-branch', 'NFC': 'fas fa-wifi',
        'SNMP': 'fas fa-exchange-alt', 'XML': 'fas fa-file-code', 'default': 'fas fa-code'
    };

    function getTechIconLazy(tech) {
        return techIconMap[tech] || techIconMap.default;
    }

    function renderProfessionalProjects(container) {
        if (container.dataset.loaded) return;

        const projects = JSON.parse(container.dataset.projects || '[]');
        const t = JSON.parse(container.dataset.translations || '{}');

        container.innerHTML = projects.map((project, index) => `
            <div class="project-card group bg-light-surface dark:bg-dark-surface rounded-none overflow-hidden border border-light-border dark:border-dark-border shadow-sm hover:shadow-lg hover:border-brand-red/50 hover:-translate-y-1 h-full flex flex-col"
                 style="--delay: ${120 * index}ms" tabindex="0" role="article" aria-label="${project.title}">
                <div class="bg-brand-red p-3 flex items-center justify-between gap-3 text-white ${project.highlight ? 'border-l-4 border-l-white/50' : ''}">
                    <div class="flex items-center gap-2">
                        ${getProjectIconSvg(project.icon)}
                        <h3 class="font-bold text-lg">${project.title}</h3>
                    </div>
                    <div class="px-1.5 py-0.5 text-[10px] bg-white/90 text-red-800 rounded-none font-medium whitespace-nowrap">${project.company}</div>
                </div>
                <div class="p-5 flex-grow flex flex-col">
                    <p class="description mb-4 text-light-text-secondary dark:text-dark-text-secondary">${project.description}</p>
                    <p class="long-description mb-4 text-light-text-secondary dark:text-dark-text-secondary hidden">${project.longDescription}</p>
                    <div class="key-features mb-4 hidden">
                        <h4 class="text-sm uppercase text-brand-red font-semibold mb-2 tracking-wider">${t.keyFeatures}</h4>
                        <ul class="space-y-2 text-sm">
                            ${project.keyFeatures.map(f => `<li class="flex items-start gap-2"><span class="text-brand-red flex-shrink-0 mt-1">${projectIconSvg.check}</span><span>${f}</span></li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-auto">
                        <h4 class="text-xs uppercase text-light-text-secondary dark:text-dark-text-secondary font-semibold mb-2">${t.technologies}</h4>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${project.technologies.map(tech => `<span class="tech-tag px-2 py-1 text-xs border border-light-border dark:border-dark-border rounded-none bg-light-secondary dark:bg-dark-secondary hover:border-brand-red transition-colors duration-150 flex items-center gap-1.5"><i class="${getTechIconLazy(tech)} text-brand-red"></i>${tech}</span>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        container.dataset.loaded = 'true';
    }

    function initProjectsSection() {
        const sections = document.querySelectorAll('.projects-section:not(.initialized)');

        sections.forEach(section => {
            section.classList.add('initialized');

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.disconnect();
                        }
                    });
                },
                { threshold: 0.1 }
            );
            observer.observe(section);

            const tabBtns = section.querySelectorAll('.tab-btn');
            const personalGrid = section.querySelector('#personal-projects');
            const professionalGrid = section.querySelector('#professional-projects');
            const personalNote = section.querySelector('#personal-note');
            const professionalNote = section.querySelector('#professional-note');

            // Load professional projects immediately (since they're shown by default now)
            if (professionalGrid) renderProfessionalProjects(professionalGrid);

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');

                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'text-brand-red', 'dark:text-red-400', 'border-b-2', 'border-brand-red', 'dark:border-red-400');
                        b.classList.add('text-light-text-secondary', 'dark:text-dark-text-secondary');
                    });
                    btn.classList.add('active', 'text-brand-red', 'dark:text-red-400', 'border-b-2', 'border-brand-red', 'dark:border-red-400');
                    btn.classList.remove('text-light-text-secondary', 'dark:text-dark-text-secondary');

                    personalGrid?.classList.add('transitioning');
                    professionalGrid?.classList.add('transitioning');

                    setTimeout(() => {
                        if (tab === 'personal') {
                            personalGrid?.classList.remove('hidden');
                            professionalGrid?.classList.add('hidden');
                            personalNote?.classList.remove('hidden');
                            professionalNote?.classList.add('hidden');
                        } else {
                            // Lazy load professional projects on first click
                            if (professionalGrid) renderProfessionalProjects(professionalGrid);
                            personalGrid?.classList.add('hidden');
                            professionalGrid?.classList.remove('hidden');
                            personalNote?.classList.add('hidden');
                            professionalNote?.classList.remove('hidden');
                        }
                        personalGrid?.classList.remove('transitioning');
                        professionalGrid?.classList.remove('transitioning');
                    }, 150);
                });
            });

            const toggleBtn = section.querySelector('#toggle-all-details');
            let showingDetails = false;

            toggleBtn?.addEventListener('click', () => {
                showingDetails = !showingDetails;
                const textSpan = toggleBtn.querySelector('.btn-text');
                const showAll = toggleBtn.getAttribute('data-show-all');
                const showLess = toggleBtn.getAttribute('data-show-less');

                section.querySelectorAll('.project-card').forEach(card => {
                    const desc = card.querySelector('.description');
                    const longDesc = card.querySelector('.long-description');
                    const features = card.querySelector('.key-features');

                    if (showingDetails) {
                        desc?.classList.add('hidden');
                        longDesc?.classList.remove('hidden');
                        features?.classList.remove('hidden');
                    } else {
                        desc?.classList.remove('hidden');
                        longDesc?.classList.add('hidden');
                        features?.classList.add('hidden');
                    }
                });

                if (showingDetails) {
                    toggleBtn.classList.add('expanded');
                    if (textSpan) textSpan.textContent = showLess || 'Show less details';
                } else {
                    toggleBtn.classList.remove('expanded');
                    if (textSpan) textSpan.textContent = showAll || 'Show all details';
                }
            });

            section.querySelectorAll('#personal-projects .project-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.github-link') || e.target.closest('.tech-tag')) return;
                    const githubUrl = card.getAttribute('data-github-url');
                    if (githubUrl) window.open(githubUrl, '_blank', 'noopener,noreferrer');
                });
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const githubUrl = card.getAttribute('data-github-url');
                        if (githubUrl) window.open(githubUrl, '_blank', 'noopener,noreferrer');
                    }
                });
            });
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProjectsSection);
    } else {
        initProjectsSection();
    }
    document.addEventListener('astro:page-load', initProjectsSection);
</script>
