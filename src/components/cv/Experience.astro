---
/**
 * Experience component - Pure Astro with vanilla JS for expand/collapse
 * @file src/components/cv/Experience.astro
 */
import { getExperiences } from '../../data/experiences';
import SvgIcons from '../icons/SvgIcons.astro';

interface Props {
    lang?: string;
}

const { lang = 'en' } = Astro.props;

// Get translated data at build time
const experiences = getExperiences(lang);

// UI translations
const translationsByLang: Record<string, Record<string, string>> = {
    en: {
        title: 'Work Experience',
        responsibilities: 'Responsibilities',
        keyAchievements: 'Key Achievements',
        showMore: 'Show more',
        showLess: 'Show less'
    },
    es: {
        title: 'Experiencia Laboral',
        responsibilities: 'Responsabilidades',
        keyAchievements: 'Logros Clave',
        showMore: 'Ver más',
        showLess: 'Ver menos'
    },
    fr: {
        title: 'Expérience Professionnelle',
        responsibilities: 'Responsabilités',
        keyAchievements: 'Réalisations Clés',
        showMore: 'Voir plus',
        showLess: 'Voir moins'
    },
    de: {
        title: 'Berufserfahrung',
        responsibilities: 'Verantwortlichkeiten',
        keyAchievements: 'Wichtige Erfolge',
        showMore: 'Mehr anzeigen',
        showLess: 'Weniger anzeigen'
    }
};

const t = translationsByLang[lang] || translationsByLang.en;

// Additional translations for collapsible sections
const showDetailsText: Record<string, string> = {
    en: 'Show details',
    es: 'Ver detalles',
    fr: 'Voir détails',
    de: 'Details anzeigen'
};
const hideDetailsText: Record<string, string> = {
    en: 'Hide details',
    es: 'Ocultar detalles',
    fr: 'Masquer détails',
    de: 'Details ausblenden'
};
---

<section id="experience" class="scroll-mt-20 mb-8 sm:mb-16 mt-2 sm:mt-8 experience-section">
    <div class="flex items-center gap-4 mb-10 section-header">
        <div class="h-10 w-10 bg-brand-red dark:bg-brand-red rounded-none flex items-center justify-center flex-shrink-0 transition-colors duration-150 section-icon">
            <SvgIcons name="briefcase" class="w-4 h-4 text-white" />
        </div>
        <h2 class="text-3xl font-bold tracking-tight">{t.title}</h2>
    </div>

    <div class="relative pl-5 md:pl-8">
        <!-- Timeline line -->
        <div class="absolute left-2 top-4 bottom-0 w-0.5 bg-gradient-to-b from-brand-red via-brand-red/70 to-gray-300 dark:from-brand-red dark:via-brand-red/50 dark:to-gray-700"></div>

        {experiences.map((job, index) => (
            <div
                class={`experience-item relative pl-8 pb-16 hover:translate-x-1 transition-all duration-200 ${job.collapsible ? 'collapsible-job' : ''}`}
                style={`--delay: ${100 * index}ms`}
                data-collapsible={job.collapsible ? 'true' : 'false'}
            >
                <!-- Timeline node now via CSS ::before -->

                <!-- Job header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-4 group">
                    <div class="flex items-center gap-3">
                        {job.collapsible && (
                            <button
                                class="collapsible-toggle w-8 h-8 flex items-center justify-center text-brand-red hover:bg-brand-red/10 rounded-none transition-colors"
                                data-job-id={job.id}
                                data-show-text={showDetailsText[lang]}
                                data-hide-text={hideDetailsText[lang]}
                                aria-expanded="false"
                                aria-label={showDetailsText[lang]}
                            >
                                <span class="toggle-icon transition-transform duration-200">
                                    <SvgIcons name="chevron-right" class="w-3 h-3" />
                                </span>
                            </button>
                        )}
                        <div>
                            <h3 class="text-xl font-bold group-hover:text-brand-red transition-colors duration-150">
                                {job.title}
                            </h3>
                            <p class="text-light-text-secondary dark:text-dark-text-secondary transition-colors duration-150 flex items-center">
                                <span class="mr-2 text-brand-red/70"><SvgIcons name="building" class="w-3 h-3" /></span>
                                {job.companyUrl ? (
                                    <a
                                        href={job.companyUrl}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="hover:text-brand-red dark:hover:text-brand-red transition-colors"
                                    >
                                        {job.company}
                                    </a>
                                ) : (
                                    job.company
                                )}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-light-text dark:text-dark-text-secondary bg-light-secondary dark:bg-dark-secondary px-3 py-1 rounded-none transition-all duration-150 group-hover:bg-brand-red group-hover:text-white">
                        <SvgIcons name="calendar-alt" class="w-3 h-3" />
                        <span>{job.period}</span>
                    </div>
                </div>

                <!-- Job description card -->
                <div class={`bg-light-surface dark:bg-dark-surface p-6 rounded-none border border-light-border dark:border-dark-border group hover:border-brand-red/30 dark:hover:border-brand-red/30 hover:shadow-md job-card ${job.collapsible ? 'collapsible-content hidden' : ''}`} data-job-content={job.id}>
                    <!-- Responsibilities -->
                    <h4 class="text-sm uppercase text-light-text-secondary dark:text-dark-text-secondary font-semibold mb-3 tracking-wider">
                        {t.responsibilities}
                    </h4>
                    <ul class="space-y-3 text-light-text dark:text-dark-text mb-3">
                        {job.keyResponsibilities && job.keyResponsibilities.map((responsibility: string) => (
                            <li class="flex items-start gap-2">
                                <span class="w-1.5 h-1.5 bg-brand-red flex-shrink-0 mt-2"></span>
                                <span>{responsibility}</span>
                            </li>
                        ))}
                    </ul>

                    <!-- Extra responsibilities - expandable -->
                    {job.extraResponsibilities && job.extraResponsibilities.length > 0 && (
                        <>
                            <ul class="extra-responsibilities space-y-3 text-light-text dark:text-dark-text mb-3 hidden" data-job-id={job.id}>
                                {job.extraResponsibilities.map((responsibility: string) => (
                                    <li class="flex items-start gap-2">
                                        <span class="w-1.5 h-1.5 bg-brand-red flex-shrink-0 mt-2"></span>
                                        <span>{responsibility}</span>
                                    </li>
                                ))}
                            </ul>

                            <button
                                class="expand-btn text-xs inline-flex items-center gap-1 text-brand-red hover:text-brand-red/80 mb-5 focus:outline-none focus:underline"
                                data-job-id={job.id}
                                data-show-more={t.showMore}
                                data-show-less={t.showLess}
                                aria-expanded="false"
                            >
                                <span class="expand-icon transition-transform duration-200">
                                    <SvgIcons name="chevron-down" class="w-3 h-3" />
                                </span>
                                <span class="btn-text">{t.showMore}</span>
                            </button>
                        </>
                    )}

                    <!-- Achievements -->
                    <h4 class="text-sm uppercase text-brand-red dark:text-brand-red font-semibold mb-3 tracking-wider">
                        {t.keyAchievements}
                    </h4>
                    <ul class="space-y-3 text-light-text dark:text-dark-text">
                        {job.achievements && job.achievements.map((achievement: string) => (
                            <li class="flex items-start gap-2">
                                <span class="text-brand-red flex-shrink-0 mt-1"><SvgIcons name="trophy" class="w-4 h-4" /></span>
                                <span>{achievement}</span>
                            </li>
                        ))}
                    </ul>

                    {/* Tech Stack Tags */}
                    {job.techStack && job.techStack.length > 0 && (
                        <div class="mt-4 pt-4 border-t border-light-border dark:border-dark-border">
                            <div class="flex flex-wrap gap-2">
                                {job.techStack.map((tech: string) => (
                                    <span class="px-2 py-1 text-xs font-medium bg-brand-red/10 text-brand-red dark:bg-brand-red/20 dark:text-red-300 border border-brand-red/20 rounded-none">
                                        {tech}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}

                    <!-- Hover indicator line -->
                    <div class="w-0 h-0.5 bg-brand-red mt-4 transition-all duration-150 group-hover:w-full"></div>
                </div>
            </div>
        ))}
    </div>
</section>

<style>
    /* Initial state - hidden */
    .section-header,
    .experience-item {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 200ms ease-out, transform 200ms ease-out;
        transition-delay: var(--delay, 0ms);
    }

    /* Visible state */
    .experience-section.visible .section-header,
    .experience-section.visible .experience-item {
        opacity: 1;
        transform: translateY(0);
    }

    /* Timeline node via CSS ::before (replaces div) */
    .experience-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 16px;
        width: 16px;
        height: 16px;
        background: var(--brand-red, #d83333);
        border: 4px solid white;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        z-index: 1;
        transform: scale(0);
        transition: transform 200ms ease-out;
        transition-delay: var(--delay, 0ms);
    }

    :global(.dark) .experience-item::before {
        border-color: #111827;
    }

    .experience-section.visible .experience-item::before {
        transform: scale(1);
    }

    /* Job card transitions */
    .job-card {
        transition: background-color 100ms ease-out, border-color 100ms ease-out, box-shadow 150ms ease-out;
    }

    /* Extra responsibilities animation */
    .extra-responsibilities {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 300ms ease-out, opacity 200ms ease-out;
    }

    .extra-responsibilities.expanded {
        max-height: 1000px;
        opacity: 1;
    }

    /* Collapsible job card animation */
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        padding: 0;
        margin: 0;
        border: none;
        transition: max-height 300ms ease-out, opacity 200ms ease-out, padding 200ms ease-out;
    }

    .collapsible-content.expanded {
        max-height: 2000px;
        opacity: 1;
        padding: 1.5rem;
        border: 1px solid;
    }

    .collapsible-toggle .toggle-icon {
        display: inline-block;
        transition: transform 200ms ease-out;
    }

    .collapsible-toggle[aria-expanded="true"] .toggle-icon {
        transform: rotate(90deg);
    }

    .expand-btn .expand-icon {
        display: inline-block;
        transition: transform 200ms ease-out;
    }

    .expand-btn[aria-expanded="true"] .expand-icon {
        transform: rotate(180deg);
    }

    /* Reduce bottom padding when collapsed */
    .collapsible-job:not(.expanded) {
        padding-bottom: 1.5rem;
    }
</style>

<script>
    function initExperienceSection() {
        const sections = document.querySelectorAll('.experience-section:not(.initialized)');

        sections.forEach(section => {
            section.classList.add('initialized');

            // IntersectionObserver for scroll animation
            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.disconnect();
                        }
                    });
                },
                { threshold: 0.1 }
            );

            observer.observe(section);

            // Collapsible job card functionality (for Early Career, etc.)
            const collapsibleToggles = section.querySelectorAll('.collapsible-toggle');
            collapsibleToggles.forEach(btn => {
                btn.addEventListener('click', () => {
                    const jobId = btn.getAttribute('data-job-id');
                    const content = section.querySelector(`.collapsible-content[data-job-content="${jobId}"]`);
                    const jobItem = btn.closest('.collapsible-job');
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';

                    if (content) {
                        if (isExpanded) {
                            content.classList.remove('expanded');
                            content.classList.add('hidden');
                            jobItem?.classList.remove('expanded');
                            btn.setAttribute('aria-expanded', 'false');
                            btn.setAttribute('aria-label', btn.getAttribute('data-show-text') || 'Show details');
                        } else {
                            content.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                content.classList.add('expanded');
                            });
                            jobItem?.classList.add('expanded');
                            btn.setAttribute('aria-expanded', 'true');
                            btn.setAttribute('aria-label', btn.getAttribute('data-hide-text') || 'Hide details');
                        }
                    }
                });
            });

            // Expand/collapse functionality
            const expandBtns = section.querySelectorAll('.expand-btn');
            expandBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const jobId = btn.getAttribute('data-job-id');
                    const extraList = section.querySelector(`.extra-responsibilities[data-job-id="${jobId}"]`);
                    const textSpan = btn.querySelector('.btn-text');
                    const showMore = btn.getAttribute('data-show-more');
                    const showLess = btn.getAttribute('data-show-less');

                    if (extraList) {
                        const isExpanded = extraList.classList.contains('expanded');

                        if (isExpanded) {
                            extraList.classList.remove('expanded');
                            extraList.classList.add('hidden');
                            if (textSpan) textSpan.textContent = showMore || 'Show more';
                            btn.setAttribute('aria-expanded', 'false');
                        } else {
                            extraList.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                extraList.classList.add('expanded');
                            });
                            if (textSpan) textSpan.textContent = showLess || 'Show less';
                            btn.setAttribute('aria-expanded', 'true');
                        }
                    }
                });
            });
        });
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initExperienceSection);
    } else {
        initExperienceSection();
    }

    // Re-run on Astro page transitions
    document.addEventListener('astro:page-load', initExperienceSection);
</script>
