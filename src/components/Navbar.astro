---
/**
 * Navbar component - Pure Astro + Vanilla JS (no React)
 * Eliminates 131KB of React runtime from initial bundle
 * @file src/components/Navbar.astro
 */
import { navItems, uiTranslations, getNavItems, getUITranslation } from '../data/navigation';
import SvgIcons from './icons/SvgIcons.astro';

interface Props {
    lang?: string;
}

const { lang = 'en' } = Astro.props;

// Get translated nav items and UI texts at build time
const translatedNavItems = getNavItems(lang);
const uiTexts = {
    downloadCV: getUITranslation('downloadCV', lang),
    backToTop: getUITranslation('backToTop', lang),
    openMenu: getUITranslation('openMenu', lang),
    closeMenu: getUITranslation('closeMenu', lang),
};

// Language options for selector
const languageOptions = [
    { code: 'en', name: 'English' },
    { code: 'es', name: 'Español' },
    { code: 'fr', name: 'Français' },
    { code: 'de', name: 'Deutsch' }
];
---

<nav
    id="main-navbar"
    class="py-4 sticky top-0 z-50 bg-white/50 dark:bg-dark-primary/50 backdrop-blur-sm border-b border-gray-200 dark:border-dark-border"
    role="navigation"
    aria-label="Main Navigation"
    data-lang={lang}
>
    <div class="container mx-auto px-4 flex justify-between items-center max-w-5xl">
        <!-- Logo section -->
        <div class="flex items-center gap-4">
            <button
                id="navbar-logo"
                class="flex items-center gap-2 cursor-pointer bg-transparent border-none p-0"
                type="button"
                aria-label="Go to top of page"
            >
                <span class="w-12 h-12 flex items-center justify-center bg-brand-red text-white text-lg font-bold">OM</span>
                <span class="font-medium tracking-tight whitespace-nowrap">Oriol Macias</span>
            </button>

            <!-- Social links (desktop) -->
            <div class="hidden md:flex items-center gap-3">
                <a
                    href="https://github.com/MaciWP"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-brand-red dark:text-red-400 hover:text-brand-red/80 dark:hover:text-red-400/80 transition-colors"
                    aria-label="GitHub Profile"
                >
                    <SvgIcons name="github" class="w-5 h-5" />
                </a>
                <a
                    href="https://linkedin.com/in/oriolmaciasbadosa"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-brand-red dark:text-red-400 hover:text-brand-red/80 dark:hover:text-red-400/80 transition-colors"
                    aria-label="LinkedIn Profile"
                >
                    <SvgIcons name="linkedin" class="w-5 h-5" />
                </a>
            </div>
        </div>

        <!-- Desktop Navigation -->
        <ul class="hidden md:flex justify-center space-x-1" id="desktop-nav">
            {translatedNavItems.map((item) => (
                <li class="flex-shrink-0">
                    <a
                        href={item.href}
                        class="nav-link relative px-2 py-2 text-sm font-medium transition-colors duration-100 block text-center whitespace-nowrap text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"
                        data-section={item.id}
                    >
                        {item.name}
                        <span class="nav-indicator absolute -bottom-1 left-0 right-0 h-0.5 bg-brand-red dark:bg-brand-red hidden" aria-hidden="true"></span>
                    </a>
                </li>
            ))}
        </ul>

        <!-- Controls -->
        <div class="flex items-center gap-2">
            <!-- Language Selector -->
            <div class="relative" id="lang-selector">
                <button
                    id="lang-toggle"
                    class="flex items-center space-x-1 p-2 rounded-none border border-gray-300 dark:border-gray-600 hover:border-brand-red focus:border-brand-red focus:outline-none focus:ring-2 focus:ring-brand-red bg-light-surface dark:bg-dark-surface transition-colors"
                    aria-expanded="false"
                    aria-haspopup="listbox"
                >
                    <span class="text-sm font-medium">{lang.toUpperCase()}</span>
                    <svg class="w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div
                    id="lang-dropdown"
                    class="hidden absolute right-0 mt-2 w-36 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-none shadow-lg z-50 overflow-hidden"
                    role="listbox"
                >
                    <div class="py-1">
                        {languageOptions.map((option) => (
                            <button
                                class={`lang-option w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${lang === option.code ? 'bg-brand-red/10 text-brand-red' : 'text-gray-700 dark:text-gray-200'}`}
                                data-lang={option.code}
                                role="option"
                                aria-selected={lang === option.code ? "true" : "false"}
                            >
                                {option.name}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            <!-- Theme Toggle -->
            <button
                id="theme-toggle"
                class="p-2 rounded-none text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-brand-red focus:ring-offset-2 dark:focus:ring-offset-gray-900"
                aria-label="Switch to light mode"
                aria-pressed="true"
                type="button"
            >
                <!-- Sun icon (shown in dark mode) -->
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon icon (shown in light mode) -->
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
                <span class="sr-only">Switch theme</span>
            </button>

            <!-- Download CV Button (desktop) -->
            <a
                href="/OriolMacias_CV.pdf"
                download="OriolMacias_CV.pdf"
                class="hidden sm:inline-flex items-center px-3 py-1.5 text-sm text-white bg-brand-red rounded-none hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-brand-red focus:ring-offset-2 dark:focus:ring-offset-gray-900 whitespace-nowrap"
                id="cv-download-button"
            >
                <span class="mr-1.5"><SvgIcons name="download" class="w-4 h-4" /></span>
                <span>{uiTexts.downloadCV}</span>
            </a>

            <!-- Mobile Menu Button -->
            <button
                id="mobile-menu-button"
                class="md:hidden p-2 rounded-none hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none transition-colors"
                aria-label={uiTexts.openMenu}
                aria-expanded="false"
                aria-controls="mobile-menu"
                aria-haspopup="menu"
            >
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path id="menu-icon-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    <path id="menu-icon-close" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation Menu -->
    <div
        id="mobile-menu"
        class="md:hidden hidden absolute left-0 right-0 px-4 pt-2 pb-4 bg-white dark:bg-dark-primary border-b border-gray-200 dark:border-dark-border shadow-lg"
        role="menu"
        aria-labelledby="mobile-menu-button"
    >
        <div class="flex flex-col space-y-3">
            {translatedNavItems.map((item) => (
                <a
                    href={item.href}
                    class="mobile-nav-link text-sm font-medium py-2 px-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"
                    role="menuitem"
                    data-section={item.id}
                >
                    {item.name}
                </a>
            ))}

            <!-- Social links (mobile) -->
            <div class="flex items-center gap-4 py-2 px-3 border-t border-gray-200 dark:border-gray-700 mt-2">
                <a
                    href="https://github.com/MaciWP"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-brand-red dark:text-red-400 hover:text-brand-red/80 dark:hover:text-red-400/80 transition-colors"
                    aria-label="GitHub Profile"
                    role="menuitem"
                >
                    <SvgIcons name="github" class="w-5 h-5" />
                </a>
                <a
                    href="https://linkedin.com/in/oriolmaciasbadosa"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-brand-red dark:text-red-400 hover:text-brand-red/80 dark:hover:text-red-400/80 transition-colors"
                    aria-label="LinkedIn Profile"
                    role="menuitem"
                >
                    <SvgIcons name="linkedin" class="w-5 h-5" />
                </a>
            </div>

            <!-- Download button (mobile) -->
            <a
                href="/OriolMacias_CV.pdf"
                download="OriolMacias_CV.pdf"
                class="inline-flex items-center justify-center mt-3 px-3 py-2 text-sm text-white bg-brand-red rounded-none hover:bg-red-700 transition-colors"
                role="menuitem"
            >
                <span class="mr-1.5"><SvgIcons name="download" class="w-4 h-4" /></span>
                <span>{uiTexts.downloadCV}</span>
            </a>
        </div>
    </div>
</nav>

<script is:inline>
// Inline script eliminates HTTP request from critical path
// Defer execution to not block HTML parser - improves LCP
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavbar);
} else {
    initNavbar();
}

function initNavbar() {
    const navbar = document.getElementById('main-navbar');
    if (!navbar) return;

    const lang = navbar.dataset.lang || 'en';
    const NAVBAR_HEIGHT = 80;
    const SECTION_IDS = ['experience', 'skills', 'education', 'languages', 'projects'];

    // Elements
    const logoBtn = document.getElementById('navbar-logo');
    const themeBtn = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const mobileMenuBtn = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIconOpen = document.getElementById('menu-icon-open');
    const menuIconClose = document.getElementById('menu-icon-close');
    const langToggle = document.getElementById('lang-toggle');
    const langDropdown = document.getElementById('lang-dropdown');
    const navLinks = document.querySelectorAll('.nav-link');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    let activeSection = 'experience';
    let isMenuOpen = false;
    let isLangOpen = false;

    // Initialize theme icons
    function updateThemeIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        if (sunIcon && moonIcon && themeBtn) {
            sunIcon.classList.toggle('hidden', !isDark);
            moonIcon.classList.toggle('hidden', isDark);
            themeBtn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
            themeBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        }
    }

    // Update active nav link
    function updateActiveLink(sectionId) {
        activeSection = sectionId;
        navLinks.forEach(link => {
            const isActive = link.getAttribute('data-section') === sectionId;
            link.classList.toggle('text-brand-red', isActive);
            link.classList.toggle('dark:text-brand-red', isActive);
            link.classList.toggle('text-gray-600', !isActive);
            link.classList.toggle('dark:text-gray-400', !isActive);
            const indicator = link.querySelector('.nav-indicator');
            if (indicator) {
                indicator.classList.toggle('hidden', !isActive);
            }
            if (isActive) {
                link.setAttribute('aria-current', 'page');
            } else {
                link.removeAttribute('aria-current');
            }
        });
        mobileNavLinks.forEach(link => {
            const isActive = link.getAttribute('data-section') === sectionId;
            link.classList.toggle('text-brand-red', isActive);
            link.classList.toggle('dark:text-brand-red', isActive);
            link.classList.toggle('bg-gray-100', isActive);
            link.classList.toggle('dark:bg-gray-800', isActive);
        });
    }

    // IntersectionObserver for active section detection (no reflow)
    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const sectionId = entry.target.id;
                if (sectionId && sectionId !== activeSection) {
                    updateActiveLink(sectionId);
                }
            }
        });
    }, {
        rootMargin: `-${NAVBAR_HEIGHT + 50}px 0px -50% 0px`,
        threshold: 0
    });

    // Observe all sections
    SECTION_IDS.forEach(id => {
        const element = document.getElementById(id);
        if (element) sectionObserver.observe(element);
    });

    // Scroll effect for navbar - optimized single class toggle
    let wasScrolled = false;
    function updateNavbarScroll() {
        const isScrolled = window.scrollY > 50;
        if (isScrolled === wasScrolled) return;
        wasScrolled = isScrolled;
        navbar.classList.toggle('navbar-scrolled', isScrolled);
    }

    // Throttled scroll handler (only for navbar effect now)
    let ticking = false;
    function handleScroll() {
        if (!ticking) {
            requestAnimationFrame(() => {
                updateNavbarScroll();
                ticking = false;
            });
            ticking = true;
        }
    }

    // Navigation click handler
    function handleNavClick(e, targetId) {
        e.preventDefault();
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            updateActiveLink(targetId);
            const position = targetElement.getBoundingClientRect().top + window.pageYOffset - NAVBAR_HEIGHT;
            window.scrollTo({ top: position, behavior: 'smooth' });
            history.pushState(null, '', `#${targetId}`);
            if (window.announceToScreenReader) {
                window.announceToScreenReader(`Navigated to ${targetId} section`);
            }
        }
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
        isMenuOpen = !isMenuOpen;
        mobileMenu?.classList.toggle('hidden', !isMenuOpen);
        menuIconOpen?.classList.toggle('hidden', isMenuOpen);
        menuIconClose?.classList.toggle('hidden', !isMenuOpen);
        mobileMenuBtn?.setAttribute('aria-expanded', isMenuOpen ? 'true' : 'false');
    }

    function closeMobileMenu() {
        if (isMenuOpen) {
            isMenuOpen = false;
            mobileMenu?.classList.add('hidden');
            menuIconOpen?.classList.remove('hidden');
            menuIconClose?.classList.add('hidden');
            mobileMenuBtn?.setAttribute('aria-expanded', 'false');
        }
    }

    // Language selector toggle
    function toggleLangDropdown() {
        isLangOpen = !isLangOpen;
        langDropdown?.classList.toggle('hidden', !isLangOpen);
        langToggle?.setAttribute('aria-expanded', isLangOpen ? 'true' : 'false');
        langToggle?.querySelector('svg')?.classList.toggle('rotate-180', isLangOpen);
    }

    function closeLangDropdown() {
        if (isLangOpen) {
            isLangOpen = false;
            langDropdown?.classList.add('hidden');
            langToggle?.setAttribute('aria-expanded', 'false');
            langToggle?.querySelector('svg')?.classList.remove('rotate-180');
        }
    }

    // Language change handler
    function handleLanguageChange(langCode) {
        if (langCode === lang) {
            closeLangDropdown();
            return;
        }
        let path = window.location.pathname;
        // Handle both with and without trailing slash
        const langPrefixes = ['/es/', '/fr/', '/de/'];
        const langPaths = ['/es', '/fr', '/de'];

        // Strip locale prefix from path
        for (const prefix of langPrefixes) {
            if (path.startsWith(prefix)) {
                path = '/' + path.substring(prefix.length);
                break;
            }
        }
        // Handle exact locale paths (e.g., /es, /fr, /de)
        if (langPaths.includes(path)) {
            path = '/';
        }
        if (!path || path === '') path = '/';
        const newUrl = langCode === 'en' ? path : `/${langCode}${path === '/' ? '' : path}`;
        window.location.href = newUrl;
    }

    // Theme toggle
    function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.classList.remove('light', 'dark');
        document.documentElement.classList.add(newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcons();
        if (window.announceToScreenReader) {
            window.announceToScreenReader(`Theme changed to ${newTheme} mode`);
        }
    }

    // Logo click - scroll to top
    function handleLogoClick() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        updateActiveLink('experience');
        history.pushState(null, '', window.location.pathname);
        if (window.announceToScreenReader) {
            window.announceToScreenReader('Returned to the top of the page');
        }
    }

    // Event listeners
    window.addEventListener('scroll', handleScroll, { passive: true });

    logoBtn?.addEventListener('click', handleLogoClick);

    themeBtn?.addEventListener('click', toggleTheme);

    mobileMenuBtn?.addEventListener('click', toggleMobileMenu);

    langToggle?.addEventListener('click', toggleLangDropdown);

    // Nav links
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const sectionId = link.getAttribute('data-section');
            if (sectionId) handleNavClick(e, sectionId);
        });
    });

    mobileNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const sectionId = link.getAttribute('data-section');
            if (sectionId) {
                handleNavClick(e, sectionId);
                closeMobileMenu();
            }
        });
    });

    // Language options
    document.querySelectorAll('.lang-option').forEach(btn => {
        btn.addEventListener('click', () => {
            const langCode = btn.getAttribute('data-lang');
            if (langCode) handleLanguageChange(langCode);
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        const target = e.target;
        if (!langToggle?.contains(target) && !langDropdown?.contains(target)) {
            closeLangDropdown();
        }
        if (!mobileMenuBtn?.contains(target) && !mobileMenu?.contains(target)) {
            closeMobileMenu();
        }
    });

    // Escape key closes menus
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeLangDropdown();
            closeMobileMenu();
        }
    });

    // Initialize
    updateThemeIcons();
    // IntersectionObserver auto-detects on page load
} // end initNavbar
</script>
