#!/usr/bin/env python3
"""
Hook: Enforce Phase 1 Agents (STRICT MODE)

REGLA SIMPLE:
1. Primero: Skill('adaptive-meta-orchestrator')
2. Después: Los 4 agentes de Phase 1 (en cualquier orden)
3. Solo entonces: Cualquier otra herramienta

BLOQUEA todo hasta que Phase 1 esté completa.
"""

import json
import sys
from pathlib import Path
from datetime import datetime

# State file
STATE_DIR = Path(__file__).parent.parent / "state"
STATE_FILE = STATE_DIR / "phase1-state.json"

# Los 4 agentes obligatorios de Phase 1
PHASE_1_AGENTS = {
    "phase-1a-keyword-detector",
    "phase-1b-complexity-scorer",
    "phase-1c-prompt-quality",
    "phase-1d-confidence-assessor"
}

# Herramientas siempre permitidas (no requieren Phase 1)
ALWAYS_ALLOWED = {
    "Skill",           # Activar skills
    "SlashCommand",    # Comandos
    "Task",            # Invocar agentes (se valida cuál)
    "TodoWrite",       # Tracking
    "AskUserQuestion", # Preguntar al usuario
}


def load_state():
    """Cargar estado de Phase 1."""
    default = {
        "skill_activated": False,
        "agents_invoked": [],
        "phase_1_complete": False,
    }
    try:
        if STATE_FILE.exists():
            with open(STATE_FILE, "r") as f:
                return json.load(f)
    except:
        pass
    return default


def save_state(state):
    """Guardar estado."""
    try:
        STATE_DIR.mkdir(parents=True, exist_ok=True)
        with open(STATE_FILE, "w") as f:
            json.dump(state, f, indent=2)
    except:
        pass


def get_agent_name(hook_data):
    """Extraer nombre del agente de Task()."""
    try:
        tool_input = hook_data.get("tool_input", {})
        if isinstance(tool_input, dict):
            return tool_input.get("subagent_type", "")
    except:
        pass
    return ""


def is_orchestrator_skill(hook_data):
    """Verificar si es Skill('adaptive-meta-orchestrator')."""
    try:
        data_str = json.dumps(hook_data).lower()
        return "adaptive-meta-orchestrator" in data_str
    except:
        return False


def main():
    try:
        hook_data = json.load(sys.stdin)
        tool_name = hook_data.get("tool_name", "")

        state = load_state()

        # ========================================
        # PASO 1: ¿Es el skill del orquestador?
        # ========================================
        if tool_name == "Skill" and is_orchestrator_skill(hook_data):
            state["skill_activated"] = True
            state["agents_invoked"] = []
            state["phase_1_complete"] = False
            save_state(state)
            sys.exit(0)  # PERMITIDO

        # ========================================
        # PASO 2: ¿Skill ya activado?
        # ========================================
        if not state.get("skill_activated", False):
            # Si no se ha activado el skill, solo permitir Skill
            if tool_name == "Skill":
                sys.exit(0)  # Permitir otros skills

            # Bloquear todo lo demás
            print("[BLOCKED] Debes activar Skill('adaptive-meta-orchestrator') primero", file=sys.stderr)
            sys.exit(2)

        # ========================================
        # PASO 3: ¿Phase 1 ya completa?
        # ========================================
        if state.get("phase_1_complete", False):
            # Phase 1 completa - permitir todo
            save_state(state)
            sys.exit(0)

        # ========================================
        # PASO 4: Phase 1 en progreso - solo Task() con agentes Phase 1
        # ========================================

        # Permitir herramientas que no interfieren
        if tool_name in {"TodoWrite", "AskUserQuestion", "SlashCommand"}:
            sys.exit(0)

        # Si es Task, verificar que sea un agente de Phase 1
        if tool_name == "Task":
            agent_name = get_agent_name(hook_data)

            # ¿Es un agente de Phase 1?
            if agent_name in PHASE_1_AGENTS:
                if agent_name not in state["agents_invoked"]:
                    state["agents_invoked"].append(agent_name)

                # ¿Se completaron los 4?
                if len(set(state["agents_invoked"]) & PHASE_1_AGENTS) >= 4:
                    state["phase_1_complete"] = True

                save_state(state)
                sys.exit(0)  # PERMITIDO

            # También permitir cross-phase-self-critique (para después de Phase 1)
            if agent_name == "cross-phase-self-critique":
                sys.exit(0)

            # Otro agente - bloquear
            invoked = state.get("agents_invoked", [])
            missing = PHASE_1_AGENTS - set(invoked)

            print(f"[BLOCKED] Phase 1 incompleta", file=sys.stderr)
            print(f"", file=sys.stderr)
            print(f"Agentes invocados: {invoked}", file=sys.stderr)
            print(f"Faltan: {list(missing)}", file=sys.stderr)
            print(f"", file=sys.stderr)
            print(f"Debes invocar los 4 agentes de Phase 1 antes de usar '{agent_name}':", file=sys.stderr)
            for agent in missing:
                print(f"  Task(subagent_type='{agent}', ...)", file=sys.stderr)
            sys.exit(2)

        # ========================================
        # PASO 5: Cualquier otra herramienta - BLOQUEAR
        # ========================================
        invoked = state.get("agents_invoked", [])
        missing = PHASE_1_AGENTS - set(invoked)

        print(f"[BLOCKED] Phase 1 incompleta - no puedes usar {tool_name}", file=sys.stderr)
        print(f"", file=sys.stderr)
        print(f"Agentes invocados: {invoked}", file=sys.stderr)
        print(f"Faltan: {list(missing)}", file=sys.stderr)
        print(f"", file=sys.stderr)
        print(f"Debes invocar los 4 agentes de Phase 1 primero:", file=sys.stderr)
        for agent in missing:
            print(f"  Task(subagent_type='{agent}', ...)", file=sys.stderr)
        sys.exit(2)

    except json.JSONDecodeError:
        sys.exit(0)  # Fail-open
    except Exception as e:
        sys.exit(0)  # Fail-open


if __name__ == "__main__":
    main()
